# Code Audit 報告

**審查時間**: 2026-01-16 11:20
**審查範圍**: 搜尋功能 (Pagefind)
**檔案數量**: 4 個核心檔案

---

## 問題總覽

| 等級 | 數量 |
|------|------|
| Critical | 1 |
| Warning | 2 |
| Info | 2 |

---

## Critical 問題

### 1. Pagefind 索引版本衝突導致搜尋失敗

- **位置**: `public/pagefind/pagefind-entry.json`
- **問題**: 索引檔只記錄了 `zh-tw` 語言，但目錄中存在舊的 `zh-hant` 索引檔案，且 `pagefind-entry.json` 的 hash 指向新的 `zh-tw` 索引，但舊的 `zh-hant` 檔案可能造成混淆。

**當前 pagefind-entry.json 內容:**
```json
{"version":"1.4.0","languages":{"zh-tw":{"hash":"zh-tw_5236ebe199274","wasm":null,"page_count":46}}}
```

**目錄中發現的衝突檔案:**
- `pagefind.zh-hant_60f653e114bc2e9.pf_meta` (舊的)
- `pagefind.zh-tw_38bc44a02310b.pf_meta` (舊的)
- `pagefind.zh-tw_5236ebe199274.pf_meta` (當前使用)
- `fragment/zh-hant_*.pf_fragment` (8 個舊檔案)
- `index/zh-hant_*.pf_index` (1 個舊檔案)

- **影響**:
  1. WASM 設為 `null`，表示使用通用 WASM (`wasm.unknown.pagefind`)
  2. 舊的索引檔案可能被錯誤加載
  3. 瀏覽器快取可能載入舊的索引檔案

- **建議**:
  1. 清除 `public/pagefind/` 目錄中所有舊的索引檔案
  2. 重新執行 `npm run build` 生成乾淨的索引
  3. 考慮在 `build-search-index.ts` 中先清除舊的索引再生成新的

---

## Warning 問題

### 1. SearchBox 元件缺少錯誤狀態的使用者回饋

- **位置**: `components/ui/SearchBox.tsx:87-89`
- **問題**: 當 Pagefind 載入失敗時，只在 console 輸出警告，使用者看不到任何提示

```typescript
script.onerror = () => {
  console.warn("Failed to load Pagefind");
};
```

- **建議**: 增加一個錯誤狀態，顯示「搜尋功能暫時無法使用」的提示給使用者

---

### 2. Pagefind 初始化等待邏輯可能無限輪詢

- **位置**: `components/ui/SearchBox.tsx:107-111`
- **問題**: 搜尋時等待 Pagefind 載入的邏輯有最大 20 次嘗試（2 秒），但如果 Pagefind 從未載入成功，使用者只會看到「Searching...」狀態

```typescript
let attempts = 0;
while (!window.pagefind && attempts < 20) {
  await new Promise(resolve => setTimeout(resolve, 100));
  attempts++;
}
```

- **建議**: 當達到最大嘗試次數時，設定一個錯誤狀態並顯示給使用者

---

## Info 建議

### 1. 搜尋索引建構腳本缺少詳細日誌

- **位置**: `scripts/build-search-index.ts`
- **建議**: 增加更詳細的日誌輸出，方便除錯，例如顯示每篇文章的標題

---

### 2. 可考慮在開發環境提供搜尋除錯工具

- **位置**: `components/ui/SearchBox.tsx`
- **建議**: 在開發環境下，可以顯示 Pagefind 的載入狀態和索引資訊，方便除錯

---

## 根本原因分析

經過審查，搜尋功能無法使用的最可能原因是：

### 主要問題：索引檔案衝突

1. **舊索引未清除**: `public/pagefind/` 目錄中存在多個版本的索引檔案（`zh-hant` 和 `zh-tw`），可能造成 Pagefind 載入時的混淆

2. **快取問題**: 瀏覽器可能快取了舊的 `pagefind.js` 或索引檔案

### 驗證步驟

用戶可以在瀏覽器開發者工具中檢查：

1. **Network Tab**: 檢查 `/pagefind/pagefind.js` 是否成功載入（200 狀態碼）
2. **Network Tab**: 檢查 `/pagefind/pagefind-entry.json` 是否成功載入
3. **Network Tab**: 檢查 `/pagefind/wasm.unknown.pagefind` 是否成功載入
4. **Console Tab**: 檢查是否有任何錯誤訊息

---

## 總結

### 整體評價

搜尋功能的程式碼架構設計合理，使用 Pagefind 作為靜態網站搜尋引擎是正確的選擇。主要問題在於索引檔案管理和錯誤處理。

### 優先處理建議

1. **立即處理**: 清除 `public/pagefind/` 目錄，重新執行 `npm run build` 生成乾淨的索引
2. **短期改善**: 在 `build-search-index.ts` 開頭加入清除舊索引的邏輯
3. **長期改善**: 增加 SearchBox 的錯誤狀態顯示

### 做得好的地方

1. 使用 Pagefind 作為搜尋引擎是正確的選擇，它是專為靜態網站設計的
2. SearchBox 元件的鍵盤快捷鍵支援（Ctrl+K）很好用
3. 搜尋結果的 debounce 處理（300ms）是合適的
4. 動態載入 Pagefind 腳本可以減少首頁載入時間
5. 索引建構腳本正確處理了草稿文章的排除

---

## 修復建議

執行以下步驟來修復搜尋功能：

```bash
# 1. 清除舊的索引檔案
rm -rf public/pagefind/

# 2. 重新建構專案
npm run build

# 3. 清除瀏覽器快取後測試
```

如果問題持續，可以檢查 `build-search-index.ts` 的執行日誌，確認索引是否正確生成。
