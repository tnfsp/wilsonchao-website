# Code Audit 報告

**審查時間**: 2026-01-16 13:30
**審查範圍**: wilsonchao.com 文章排版問題
**檔案數量**: 3 個檔案

---

## 問題總覽

| 等級 | 數量 |
|------|------|
| Critical | 2 |
| Warning | 0 |
| Info | 0 |

---

## Critical 問題

### 1. h2/h3 標題間距失效 - inline-block 覆蓋了 margin

- **位置**: `app/daily/[slug]/page.tsx:58`
- **問題**: Tailwind 類別 `[&_h2]:inline-block` 和 `[&_h3]:inline-block` 將標題設為 `inline-block`，導致 CSS 中的 `margin-top` 和 `margin-bottom` 無法正常產生視覺間距
- **影響**: `<h2>本週碎碎念</h2>` 緊貼 `<h3>餘裕感</h3>`，沒有換行間距
- **根本原因**: `inline-block` 元素的垂直 margin 行為與 `block` 不同，連續的 inline-block 會緊貼

```jsx
// 問題程式碼
className="prose prose-neutral max-w-none ... [&_h2]:inline-block [&_h2]:bg-[var(--highlight)] ... [&_h3]:inline-block [&_h3]:bg-[var(--highlight)] ..."
```

**建議修復方案**:

移除 `inline-block`，改用其他方式實現 highlight 背景效果：

```jsx
// 方案 A: 使用 block + 寬度限制
className="... [&_h2]:block [&_h2]:w-fit [&_h2]:bg-[var(--highlight)] ... [&_h3]:block [&_h3]:w-fit [&_h3]:bg-[var(--highlight)] ..."

// 方案 B: 使用 CSS 的 box-decoration-break
// 在 globals.css 中：
.prose h2, .prose h3 {
  display: block;
  width: fit-content;
  background: var(--highlight);
}
```

---

### 2. `**text** [url]` 格式未正確轉換為可點擊連結

- **位置**: `scripts/sync-notion.ts:482-501`
- **問題**: 目前的處理邏輯是分開轉換 `**text**` 和 `[url]`，導致粗體文字和連結分開顯示
- **影響**: 用戶期望點擊「Doomprompting Is the New Doomscrolling」可以跳轉到連結，但目前只有 `workingtheorys.com` 可點擊

**目前輸出**:
```html
<strong>Doomprompting Is the New Doomscrolling</strong> <a href="https://workingtheorys.com">workingtheorys.com</a>
```

**期望輸出**:
```html
<a href="https://workingtheorys.com"><strong>Doomprompting Is the New Doomscrolling</strong></a>
```

```typescript
// 目前的處理（分開處理）
mergedHtml = mergedHtml.replace(/\*\*([^*]+)\*\*/g, (_, text) => `<strong>${text}</strong>`);
mergedHtml = mergedHtml.replace(/\[([a-zA-Z0-9][-a-zA-Z0-9]*\.[a-zA-Z]{2,}...)\]/g, ...);
```

**建議修復方案**:

在處理 `**text**` 和 `[url]` 之前，先處理 `**text** [url]` 的組合模式：

```typescript
// 先處理 **text** [url] 組合格式（粗體文字作為連結）
mergedHtml = mergedHtml.replace(
  /\*\*([^*]+)\*\*\s*\[([^\]]+)\]/g,
  (_, text, url) => {
    const href = url.startsWith('http') ? url : `https://${url}`;
    return `<a href="${href}" target="_blank" rel="noopener noreferrer"><strong>${text}</strong></a>`;
  }
);

// 然後再處理單獨的 **text** 和 [url]（原有邏輯）
```

---

## 總結

### 整體評價

兩個問題都是邏輯錯誤，一個是 CSS 衝突，一個是正則表達式處理順序問題。修復後可完全解決用戶反映的排版問題。

### 優先處理建議

1. **問題 1 (inline-block)**: 修改 `page.tsx` 中的 Tailwind 類別，移除 inline-block 或改用 `w-fit`
2. **問題 2 (連結格式)**: 在 `sync-notion.ts` 中新增組合格式的正則處理，需重新執行 `npm run sync:notion`

### 做得好的地方

- 已經有完整的 prose 樣式基礎設定
- 已經有 post-process 的架構，方便擴展格式轉換
- HTML escape 處理正確，沒有 XSS 風險
